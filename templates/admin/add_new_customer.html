{% extends "base.html" %}
{% block content %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body {
    background: #f8f9fa;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}
.form-container {
    max-width: 900px;
    margin: 40px auto;
    padding: 2rem;
    background: #fff;
    border-radius: 15px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
}
.form-container:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.15);
}
h2 {
    text-align: center;
    color: #0d6efd;
    margin-bottom: 1.5rem;
    font-weight: 700;
}
hr {
    border-top: 2px solid #0d6efd;
}
.nav-tabs .nav-link {
    font-weight: 500;
}
.btn {
    border-radius: 10px;
    padding: 0.5rem 1.5rem;
    font-weight: 500;
    transition: all 0.3s ease;
}
.btn-primary:hover {
    background-color: #0b5ed7;
}
.btn-secondary:hover {
    background-color: #6c757d;
    color: #fff;
}
</style>

<div class="form-container">
    <h2>➕ Add New Customer</h2>
    <hr>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <form method="POST">
        <!-- Tabs Nav -->
        <ul class="nav nav-tabs mb-3" id="customerTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="info-tab" data-bs-toggle="tab" data-bs-target="#info" type="button" role="tab">Customer Info</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="network-tab" data-bs-toggle="tab" data-bs-target="#network" type="button" role="tab">Network Info</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="coords-tab" data-bs-toggle="tab" data-bs-target="#coords" type="button" role="tab">Coordinates & Dates</button>
            </li>
        </ul>

        <!-- Tabs Content -->
        <div class="tab-content">
            <!-- Customer Info -->
            <div class="tab-pane fade show active" id="info" role="tabpanel">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Account No *</label>
                            <input type="text" name="account_no" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Customer Name *</label>
                            <input type="text" name="name" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Phone *</label>
                            <input type="text" name="phone" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" name="email" class="form-control">
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Billing Amount *</label>
                            <input type="number" step="0.01" name="billing_amount" class="form-control" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Branch *</label>
                            <select name="branch_id" id="branch_id" class="form-select" required>
                                <option value="">-- Select Branch --</option>
                                {% for branch in branches %}
                                <option value="{{ branch.id }}">{{ branch.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Router IP (Auto-filled)</label>
                            <input type="text" id="router_ip" class="form-control" readonly>
                            <input type="hidden" id="router_id" name="router_id">
                        </div>

                        <!-- ✅ Customer IP (manual input) -->
                        <div class="mb-3">
                            <label class="form-label">Customer IP Address *</label>
                            <input type="text" name="ip_address" class="form-control" placeholder="e.g. 192.168.1.10" required>
                            <small class="text-muted">Enter a valid IPv4 address (e.g., 192.168.0.10)</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Location</label>
                            <input type="text" name="location" class="form-control">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Network Info -->
            <div class="tab-pane fade" id="network" role="tabpanel">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Cable No</label>
                            <input type="text" name="cable_no" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Cable Type</label>
                            <input type="text" name="cable_type" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Splitter</label>
                            <input type="text" name="splitter" class="form-control">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Tube No</label>
                            <input type="text" name="tube_no" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Core Used</label>
                            <input type="text" name="core_used" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Loop No</label>
                            <input type="text" name="loop_no" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Power Level</label>
                            <input type="text" name="power_level" class="form-control">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Coordinates & Dates -->
            <div class="tab-pane fade" id="coords" role="tabpanel">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Final Coordinates</label>
                            <input type="text" name="final_coordinates" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Coordinates</label>
                            <input type="text" name="coordinates" class="form-control">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Start Date *</label>
                            <input type="date" name="start_date" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Contract Date</label>
                            <input type="date" name="contract_date" class="form-control">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-between mt-4">
            <button type="submit" class="btn btn-primary px-4">Add Customer</button>
            <a href="{{ url_for('list_customers') }}" class="btn btn-secondary px-4">Cancel</a>
        </div>
    </form>

    <div class="mt-3 text-center">
        <a href="{{ url_for('admin_dashboard') }}" class="btn btn-outline-dark">⬅ Back to Dashboard</a>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // ✅ Auto-fill Router IP based on selected branch (your original logic)
    document.getElementById("branch_id").addEventListener("change", function() {
        const branchId = this.value;
        if (branchId) {
            fetch(`/get_router_ip/${branchId}`)
                .then(res => res.json())
                .then(data => {
                    document.getElementById("router_ip").value = data.ip_address || "";
                    document.getElementById("router_id").value = data.id || "";
                });
        } else {
            document.getElementById("router_ip").value = "";
            document.getElementById("router_id").value = "";
        }
    });
</script>
{% endblock %}
