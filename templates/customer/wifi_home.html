{% extends "base.html" %}

{% block content %}
<div class="container d-flex justify-content-center align-items-center" style="min-height: 90vh;">
    <div class="card shadow-lg border-0" style="width: 100%; max-width: 600px; background-color: #f8f9fa;">

        <!-- ==================== CARD HEADER ==================== -->
        <div class="card-header text-white 
            {% if status == 'active' and days_left is not none and days_left <= 3 %}bg-warning
            {% elif status == 'active' %}bg-success
            {% elif status == 'grace' %}bg-warning
            {% elif status == 'suspended' %}bg-danger
            {% else %}bg-secondary
            {% endif %}">

            <div class="text-center">
                <h4 class="mb-1">Intersurf Cable Ltd - {{ customer.name }}</h4>
                {% if status == 'active' %}
                    <h5 class="mb-2">Your subscription is active</h5>
                {% elif status == 'grace' %}
                    <h5 class="mb-2 text-warning">Subscription in Grace Period</h5>
                {% elif status == 'suspended' %}
                    <h5 class="mb-2 text-danger">Subscription Suspended</h5>
                {% endif %}
                <hr>
            </div>
        </div>

        <!-- ==================== CARD BODY ==================== -->
        <div class="card-body text-center">

            {% if status == "active" %}
                <p class="fw-bold">{{ short_message }}</p>

                {% if detailed_message %}
                    <p class="fs-5">{{ detailed_message|safe }}</p>
                {% else %}
                    <!-- ✅ Use Python-passed dates (no Jinja math) -->
                    <p class="fs-5">
                        Your subscription runs from <strong>{{ start_date }}</strong> 
                        to <strong>{{ subscription_end }}</strong>.
                    </p>
                {% endif %}

                <!-- ✅ Popup controlled by show_popup -->
                {% if show_popup and days_left is not none and days_left <= 6 %}
                    <div id="subscription-popup" class="popup-container">
                        <h3>Hello {{ customer.name }}!</h3>
                        <p>Your subscription will expire in <strong>{{ days_left }}</strong> day{% if days_left > 1 %}s{% endif %}.</p>
                        <p>Please make payment to continue uninterrupted service.</p>
                        <a href="{{ url_for('wifi_access', ip_address=customer.ip_address) }}" class="btn btn-primary">OK</a>
                    </div>
                {% endif %}

            {% elif status == "grace" %}
                <p class="fw-bold">{{ short_message }}</p>

                <!-- ✅ Fix: grace_days_requested doesn't exist; use popup_shown -->
                {% if not customer.popup_shown %}
                    <form method="POST" action="{{ url_for('grace_popup', ip_address=customer.ip_address) }}" class="mt-4">
                        <div class="mb-3">
                            <label for="grace_days" class="form-label fw-bold">Select Grace Days (1-5):</label>
                            <select name="grace_days" id="grace_days" class="form-select" required>
                                {% for i in range(1, 6) %}
                                    <option value="{{ i }}">{{ i }} Day{% if i > 1 %}s{% endif %}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <button type="submit" class="btn btn-warning w-100">Request Grace Period</button>
                    </form>
                {% else %}
                    <p class="text-muted mt-3">
                        Grace already requested: <strong>{{ customer.grace_days }}</strong> day(s).
                    </p>
                {% endif %}

                <!-- ⚠️ This doesn't do anything unless you handle ?paid=true in wifi_access -->
                <form method="GET" action="{{ url_for('wifi_access', ip_address=customer.ip_address) }}" class="mt-3">
                    <button type="submit" class="btn btn-success w-100">Refresh / Continue</button>
                </form>

            {% elif status == "suspended" %}
                <p class="fw-bold">{{ short_message }}</p>
                {% if detailed_message %}
                    <p class="fs-5">{{ detailed_message|safe }}</p>
                {% endif %}
            {% endif %}

        </div>

        <!-- ==================== CARD FOOTER ==================== -->
        <div class="card-footer text-muted text-center">
            &copy; {{ current_year }} Intersurf Cable Ltd. All rights reserved.
        </div>

    </div>
</div>

<!-- ==================== POPUP STYLE & SCRIPT ==================== -->
<style>
.popup-container {
    position: fixed;
    top: 20%;
    left: 50%;
    transform: translateX(-50%);
    background: #ffffff;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    padding: 25px;
    text-align: center;
    z-index: 9999;
    animation: fadeIn 0.5s;
}
@keyframes fadeIn {
    from { opacity: 0; transform: translateX(-50%) translateY(-20px);}
    to { opacity: 1; transform: translateX(-50%) translateY(0);}
}
</style>

<script>
window.addEventListener('DOMContentLoaded', () => {
    const popup = document.getElementById('subscription-popup');
    if (popup) {
        setTimeout(() => {
            popup.style.display = 'none';
        }, 8000);
    }
});
</script>

{% endblock %}
