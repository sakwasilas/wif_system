{% extends "base.html" %}
{% block content %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<div class="container-fluid p-3">
  <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
    <div>
      <h3 class="mb-0">ðŸ“… Monthly Payments Report</h3>
      <small class="text-muted">
        Period: {{ start_dt.strftime("%Y-%m-%d") }} to {{ end_dt.strftime("%Y-%m-%d") }}
      </small>
    </div>

    <div class="d-flex gap-2 flex-wrap">
      <a href="{{ url_for('daily_report') }}" class="btn btn-outline-dark btn-sm">Daily</a>
      <a href="{{ url_for('user_dashboard') }}" class="btn btn-outline-secondary btn-sm">Dashboard</a>
    </div>
  </div>

  <!-- Month picker -->
  <form method="GET" class="card card-body shadow-sm mb-3">
    <div class="row g-2 align-items-end">
      <div class="col-md-3">
        <label class="form-label">Select Month</label>
        <input type="month" name="month" value="{{ month_value }}" class="form-control">
      </div>
      <div class="col-md-2">
        <button class="btn btn-primary w-100">View</button>
      </div>
    </div>
  </form>

  <!-- Summary cards -->
  <div class="row g-3 mb-3">
    <div class="col-md-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="text-muted">Total Payments</div>
          <h4 class="mb-0">{{ payments_count }}</h4>
        </div>
      </div>
    </div>

    <div class="col-md-8">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="text-muted">Total Amount (KES)</div>
          <h4 class="mb-0">KES {{ "{:,.2f}".format(total_amount) }}</h4>
        </div>
      </div>
    </div>
  </div>

  <!-- Method breakdown -->
  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <h5 class="mb-3">By Payment Method</h5>
      <div class="table-responsive">
        <table class="table table-sm table-striped align-middle">
          <thead class="table-dark">
            <tr>
              <th>Method</th>
              <th class="text-center">Count</th>
              <th class="text-end">Amount (KES)</th>
            </tr>
          </thead>
          <tbody>
            {% for r in method_rows %}
              <tr>
                <td>{{ r.method }}</td>
                <td class="text-center">{{ r.cnt }}</td>
                <td class="text-end">{{ "{:,.2f}".format(r.amt) }}</td>
              </tr>
            {% endfor %}
            {% if method_rows|length == 0 %}
              <tr><td colspan="3" class="text-center text-muted">No payments in this period.</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Payments list -->
  <div class="card shadow-sm">
    <div class="card-body">
      <h5 class="mb-3">Payments List</h5>
      <div class="table-responsive">
        <table class="table table-striped table-bordered align-middle">
          <thead class="table-dark">
            <tr>
              <th>Date</th>
              <th>Customer</th>
              <th>Account</th>
              <th>Branch</th>
              <th>Router</th>
              <th>Method</th>
              <th>Reference</th>
              <th class="text-end">Amount</th>
            </tr>
          </thead>
          <tbody>
            {% for p in payments %}
              <tr>
                <td>{{ p.paid_at.strftime("%Y-%m-%d %H:%M") }}</td>
                <td>{{ p.customer.name if p.customer else "" }}</td>
                <td>{{ p.customer.account_no if p.customer else "" }}</td>
                <td>{{ p.customer.router.branch.name if p.customer and p.customer.router and p.customer.router.branch else "" }}</td>
                <td>{{ p.customer.router.ip_address if p.customer and p.customer.router else "" }}</td>
                <td>{{ p.method or "Unknown" }}</td>
                <td>{{ p.reference or "" }}</td>
                <td class="text-end">{{ "{:,.2f}".format(p.amount or 0) }}</td>
              </tr>
            {% endfor %}
            {% if payments|length == 0 %}
              <tr><td colspan="8" class="text-center text-muted">No payments found.</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>
{% endblock %}